function init_canvas(a,m){var w=document.createElement("canvas");w.width=a;w.height=m;return w.getContext("2d")};function dataURItoBlob(a){var m=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var w=new ArrayBuffer(m.length),w=new DataView(w),p=0;p<m.length;p++){var d=m.charCodeAt(p);w.setUint8(p,d)}return new Blob([w],{type:a})};function merge_image(a,m,w,p,d){var h={data:{},set:function(a){this.data[a]||(this.data[a]=[]);this.data[a].push(Date.now())},get:function(){return this.data}};h.set("\u5168\u90e8");try{var k=[];m=JSON.parse(JSON.stringify(m));isNaN(m[0].zIndex)||m.sort(function(a,c){return a.zIndex-c.zIndex});var u=function(a,c,g){if(1==a.type){h.set("\u5716\u5c64"+c+"\u6587\u5b57\u5408\u6210");var b=merge_text(a,c,k);h.set("\u5716\u5c64"+c+"\u6587\u5b57\u5408\u6210");c=a.bgPadding?a.bgPadding:0;if(a.useBg){a.x-=
c;a.y-=c;var e=a.w+2*c,r=a.h+2*c,v=init_canvas(e,r);if(a.bgBorderRadius){var f=2*a.bgBorderRadius;v.lineJoin="round";v.lineWidth=f;v.strokeStyle=a.bgColor;v.strokeRect(f/2,f/2,e-f,r-f)}else f=0;v.fillStyle=a.bgColor;v.fillRect(f/2,f/2,e-f,r-f);v.drawImage(b,c,c,a.w,a.h);a.w=e;a.h=r;b=v.canvas}g&&g(b)}else if(2==a.type)b=new Image,h.set("\u5716\u5c64"+c+"\u5716\u7247\u8b80\u53d6"),b.onload=function(a,e){h.set("\u5716\u5c64"+e+"\u5716\u7247\u8b80\u53d6");g&&g(a)}.bind(this,b,c),b.src=a.image_src;else throw"\u6709\u5716\u7247\u6f0f\u6389\u6c92\u5408\u6210";
},t={finish_count:0},n;for(n in m){var q=m[n];u(q,n,function(b,c,g){b.image_object=g;c.finish_count++;if(m.length<=c.finish_count){b=init_canvas(a.w,a.h);a.format&&(a.format=a.format.toLowerCase(),c=(c=-1!=a.format.indexOf("jpeg"))||-1!=a.format.indexOf("jpg"))&&(b.fillStyle="#ffffff",b.fillRect(0,0,a.w,a.h));for(var d in m)if(c=m[d],c.image_object){g=c;if(g.rotate){var e=Math.sqrt(g.w*g.w+g.h*g.h),r=(e-g.w)/2,v=(e-g.h)/2,f=init_canvas(e,e);f.translate(e/2,e/2);f.rotate(g.rotate*Math.PI/180);f.translate(-e/
2,-e/2);f.drawImage(g.image_object,r,v);g.image_object=f.canvas;g.x-=r;g.y-=v;g.w=e;g.h=e}b.drawImage(c.image_object,c.x,c.y,c.w,c.h)}w&&w(b.canvas.toDataURL(a.format,a.compress));h.set("\u5168\u90e8");b=h.get();for(d in b)b[d]=(b[d][1]-b[d][0])/1E3;p&&p(b,k)}}.bind(this,q,t))}}catch(b){d&&d(b)}return this};function merge_text(a){function m(a){for(var b in a)"object"==typeof a[b]?a[b]=m(a[b]):isNaN(a[b])||(a[b]*=1);return a}function w(a,b,c,f,g){f.index=0;var e=[];if(-1!=a.text_content.indexOf("\n")){var r=a.text_content.split("\n"),d;for(d in r){var l=r[d],h=b.measureText(l).width;e.push({text:l,w:h})}return e}g||(g=0);var k=a.text_content,n=0;if(-1==f.source.indexOf(" ")){if(!c)if(c=0,f.list.length)for(d in f.list)l=f.list[d].text,l=b.measureText(l).width,l>c&&(c=l);else c=a.w;var m=Math.floor(c/a.text_size*
1.5),n=1,v=m}else{k=f.source.replace(/###user_name###/g,"").split(" ");if(!c)for(d in c=0,k)l=k[d].replace(/###space###/g," "),l=b.measureText(l).width,l>c&&(c=l);var n=2,y=b.measureText(" ").width,q=[];for(d in k)l=k[d].replace(/###space###/g," "),q.push(b.measureText(l).width)}Date.now();for(var u=0;;){if(1==n)for(d in l=k.substr(0,v),f.index+=l.length,f.list){var r=f.list[d].start,t=f.list[d].end;if(r<=f.index&&f.index<t){f.index-=l.length;var p=r-f.index;0==p&&(p=t-r);l=k.substr(0,p);f.index+=
l.length}}else{t=q.length;do if(r=q.slice(0,t),h=r.reduce(function(a,b){var c=0;0!=a&&(c+=y);return c+(a+b)},0),h>c)t--;else break;while(1);l=k.splice(0,t).join(" ").replace(/###space###/g," ");h=b.measureText(l).width;q.splice(0,t)}if(1==n)if(h=b.measureText(l).width,h>c)f.index-=l.length,v--;else{if(u=0,r=l.length,p=k.length-l.length,k=k.substr(r,p),l&&e.push({text:l,w:h}),v=m,!k.length){if(!f.list.length&&(p=e.length,1!=p&&e[p-2].w/2>e[p-1].w)){e=[];c*=1.1;m=Math.floor(c/a.text_size*1.5);k=a.text_content;
continue}break}}else if(l&&e.push({text:l,w:h}),!k.length)break;if(1E3<++u)throw console.log(f.source,e,u),"\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7";}k=1.2*a.text_size;a.useFontBg&&a.FontBgSize&&(k+=a.FontBgSize);m=h=0;for(d in e)m?e[d].w<m&&(m=e[d].w):m=e[d].w,e[d].w>h&&(h=e[d].w);d=k*e.length;h=x=h*a.h/a.w;if(1!=e.length&&h<d){c*=1.1;if(100<g)throw console.log("error",f.source,c,a.text_size,h,d),"\u5361\u8ff4\u5708";return w(a,b,c,f,++g)}return e}function p(a,b,c,d){var e=init_canvas(c,
d);e.fillStyle=b.text_color;e.font=b.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";e.textBaseline="middle";b.useFontBg&&b.FontBgSize&&(e.lineWidth=b.FontBgSize,e.strokeStyle=b.FontBgColor);var g=0,f=b.text_size/2;b.useFontBg&&b.FontBgSize&&(g+=b.FontBgSize);b.useFontBg&&b.FontBgSize&&e.strokeText(a,g,f);e.fillText(a,g,f);b.useLine&&(a=1==b.useLine?.9:.5,e.strokeStyle=b.text_color,e.lineWidth=Math.floor(b.text_size/10),f=d,b.useFontBg&&b.FontBgSize&&(f-=b.FontBgSize),f=f*a-e.lineWidth/2,e.moveTo(0,
f),e.lineTo(c,f),e.stroke());return e.canvas}a=JSON.parse(JSON.stringify(a));a=m(a);a.text_content=a.text_content.toString().trim();a.text_size>a.h&&(a.text_size=a.h);var d=a.text_content.match(/###user_name###([\w\W]+?)###user_name###/g),h={source:a.text_content,list:[],index:0};if(d){for(var k in d){var u=a.text_content.indexOf(d[k]),t=d[k].length,n=a.text_content.split(""),q=n.slice(u,u+t).join(""),b=q.replace(/###user_name###/g,"").replace(/###space###/g," ");n.splice(u,t,b);a.text_content=n.join("");
h.list.push({text:b,source:q,start:u,count:b.length,end:u+b.length})}h.list.reverse()}(function(a){var b=a.text_content.length,c=a.text_size;a.useFontBg&&a.FontBgSize&&(c+=2*a.FontBgSize);a.text_size=Math.floor(a.text_size*Math.sqrt(a.w*a.h/(b*c*c*1.44)))})(a);d=init_canvas(a.w,a.h);d.fillStyle=a.text_color;d.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";d.textBaseline="middle";a.useFontBg&&a.FontBgSize&&(d.lineWidth=a.FontBgSize,d.strokeStyle=a.FontBgColor);20>a.text_size&&(a.text_size=20,
d.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4");0!=a.text_type||a.text_content.match(/[^a-zA-Z0-9\.]+/)||(a.text_type=1);if(0==a.text_type)var c=w(a,d,void 0,h);else if(1==a.text_type)a.text_content=a.text_content.replace(/###user_name###/g," "),b=a.text_content,h=Math.ceil(d.measureText(b).width),c=[{text:b,w:h}];else if(2==a.text_type)for(k in a.text_content=a.text_content.replace(/###user_name###/g," "),n=a.text_content.split(""),c=[],n)b=n[k],h=Math.ceil(d.measureText(b).width),c.push({text:b,
w:h});var g=1.2*a.text_size,b=0;for(k in c)c[k].w>b&&(b=c[k].w);b=Math.ceil(b);g=Math.ceil(g);a.useFontBg&&a.FontBgSize&&(b+=a.FontBgSize,g+=a.FontBgSize);n=b;h=g*c.length;u=[];for(k in c)t=c[k],b=t.text,q=t.w,a.useFontBg&&a.FontBgSize&&(q+=2*a.FontBgSize),q=Math.ceil(q),b=p(b,a,q,g),u.push(b);c=init_canvas(n,h);g=b=0;for(k in u){var t=u[k],q=t.width,x=t.height;0==a.text_hAlign?b=0:1==a.text_hAlign?b=(n-q)/2:2==a.text_hAlign&&(b=n-q);c.drawImage(u[k],b,g,q,x);g+=x}k=a.w/n;n*=k;h*=k;h>a.h&&(k=a.h/
h,n*=k,h*=k);g=b=0;0==a.text_hAlign?b=0:1==a.text_hAlign?b=(a.w-n)/2:2==a.text_hAlign&&(b=a.w-n);0==a.text_vAlign?g=0:1==a.text_vAlign?g=(a.h-h)/2:2==a.text_vAlign&&(g=a.h-h);d.drawImage(c.canvas,b,g,n,h);return d.canvas};
