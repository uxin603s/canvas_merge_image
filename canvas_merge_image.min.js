function init_canvas(a,f){var k=document.createElement("canvas");k.width=a;k.height=f;return k.getContext("2d")};function dataURItoBlob(a){var f=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var k=new ArrayBuffer(f.length),k=new DataView(k),q=0;q<f.length;q++){var t=f.charCodeAt(q);k.setUint8(q,t)}return new Blob([k],{type:a})};function merge_image(a,f,k,q,t){var g={data:{},set:function(a){this.data[a]||(this.data[a]=[]);this.data[a].push(Date.now())},get:function(){return this.data}};g.set("\u5168\u90e8");try{var u=[];f=JSON.parse(JSON.stringify(f));isNaN(f[0].zIndex)||f.sort(function(a,c){return a.zIndex-c.zIndex});var r=function(a,c,b){if(1==a.type){g.set("\u5716\u5c64"+c+"\u6587\u5b57\u5408\u6210");var e=merge_text(a,c,u);g.set("\u5716\u5c64"+c+"\u6587\u5b57\u5408\u6210");c=a.bgPadding?a.bgPadding:0;if(a.useBg){a.x-=
c;a.y-=c;var d=a.w+2*c,f=a.h+2*c,p=init_canvas(d,f);if(a.bgBorderRadius){var l=2*a.bgBorderRadius;p.lineJoin="round";p.lineWidth=l;p.strokeStyle=a.bgColor;p.strokeRect(l/2,l/2,d-l,f-l)}else l=0;p.fillStyle=a.bgColor;p.fillRect(l/2,l/2,d-l,f-l);p.drawImage(e,c,c,a.w,a.h);a.w=d;a.h=f;e=p.canvas}b&&b(e)}else if(2==a.type)e=new Image,g.set("\u5716\u5c64"+c+"\u5716\u7247\u8b80\u53d6"),e.onload=function(a,c){g.set("\u5716\u5c64"+c+"\u5716\u7247\u8b80\u53d6");b&&b(a)}.bind(this,e,c),e.src=a.image_src;else throw"\u6709\u5716\u7247\u6f0f\u6389\u6c92\u5408\u6210";
},h={finish_count:0},n;for(n in f){var v=f[n];r(v,n,function(d,c,b){d.image_object=b;c.finish_count++;if(f.length<=c.finish_count){d=init_canvas(a.w,a.h);a.format&&(a.format=a.format.toLowerCase(),c=(c=-1!=a.format.indexOf("jpeg"))||-1!=a.format.indexOf("jpg"))&&(d.fillStyle="#ffffff",d.fillRect(0,0,a.w,a.h));for(var e in f)if(c=f[e],c.image_object){b=c;if(b.rotate){var m=Math.sqrt(b.w*b.w+b.h*b.h),h=(m-b.w)/2,p=(m-b.h)/2,l=init_canvas(m,m);l.translate(m/2,m/2);l.rotate(b.rotate*Math.PI/180);l.translate(-m/
2,-m/2);l.drawImage(b.image_object,h,p);b.image_object=l.canvas;b.x-=h;b.y-=p;b.w=m;b.h=m}d.drawImage(c.image_object,c.x,c.y,c.w,c.h)}k&&k(d.canvas.toDataURL(a.format,a.compress));g.set("\u5168\u90e8");d=g.get();for(e in d)d[e]=(d[e][1]-d[e][0])/1E3;q&&q(d,u)}}.bind(this,v,h))}}catch(d){t&&t(d)}return this};function merge_text(a,f,k){function q(a,b,e,d){if(-1!=a.text_content.indexOf("\n"))return a.text_content.split("\n");e||(e=[]);d||(d=Date.now());if(1<(Date.now()-d)/1E3)throw"\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7";var c;if(-1==a.text_content.indexOf(" ")){var f=Math.floor(a.w/a.text_size*2);c=1}else"string"==typeof a.text_content&&(a.text_content=a.text_content.split(" ")),c=2;for(var g=[],h=Date.now();;){var k=1==c?a.text_content.substr(0,f):a.text_content.join(" "),m=b.measureText(k).width;
if(1==c)if(m>a.w)f--;else{a.text_content=a.text_content.substr(k.length,a.text_content.length-k.length);break}else if(m>a.w&&1!==a.text_content.length)g.unshift(a.text_content.pop());else{a.text_content=g;break}if(1<(Date.now()-h)/1E3)throw"\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7";}""!==k.trim()&&e.push(k.trim());if(1==c){if(""==a.text_content)return e}else a.text_content=a.text_content.join(" ");return q(a,b,e,d)}function t(a,b,e){var c=e.measureText(a).width,d=1.2*b.text_size;b.useFontBg&&
b.FontBgSize&&(d+=b.FontBgSize);e=init_canvas(c,d);e.fillStyle=b.text_color;e.font=b.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";e.textBaseline="middle";var f=b.text_size/2;b.useFontBg&&b.FontBgSize&&(f+=b.FontBgSize/2,e.lineWidth=b.FontBgSize,e.strokeStyle=b.FontBgColor,e.strokeText(a,0,f));e.fillText(a,0,f);b.useLine&&(a=1==b.useLine?.9:.5,e.strokeStyle=b.text_color,e.lineWidth=Math.floor(b.text_size/10),f=d*a-e.lineWidth/2,e.moveTo(0,f),e.lineTo(c,f),e.stroke());return e.canvas}a.text_content=
a.text_content.trim();a.text_size>a.h&&(a.text_size=a.h);(function(a){var b=a.text_content.length*a.text_size*a.text_size,c=Math.sqrt(b/(a.w/a.h)),b=b/c;c>b&&(b=c);a.text_size=Math.floor(a.w/b*a.text_size)})(a);var g=init_canvas(a.w,a.h);g.fillStyle=a.text_color;g.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";g.textBaseline="middle";a.useFontBg&&a.FontBgSize&&(g.lineWidth=a.FontBgSize,g.strokeStyle=a.FontBgColor,g.strokeText(h,d,n));2==a.text_type&&(a.text_content=a.text_content.split("").join("\n"));
for(var u=0;;){u++;n=a.text_content;d=!1;if(1!=a.text_type&&a.text_content.match(/[^a-zA-Z0-9\.]+/))r=q(a,g),h=r.map(function(a){return g.measureText(a).width}).reduce(function(a,b){return a>b?a:b},0);else var r=[n],h=g.measureText(n).width;d=d||h>a.w;h=r.length*(a.useFontBg&&a.FontBgSize?1.2*a.text_size+a.FontBgSize:1.2*a.text_size);if(d=d||h>a.h)g.font=--a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4",a.text_content=n;else break}var n=0;1==a.text_vAlign?n=(a.h-h)/2:2==a.text_vAlign&&(n=a.h-h);for(var v in r){var h=
r[v].replace(/###space###/g," "),h=t(h,a,g),d=0;1==a.text_hAlign?d=(a.w-h.width)/2:2==a.text_hAlign&&(d=a.w-h.width);g.drawImage(h,d,n);n+=h.height}k.push("\u5716\u5c64"+f+"\u6587\u5b57\u5408\u6210\u5224\u65b7"+u+"\u6b21");return g.canvas};
