function init_canvas(a,h){var n=document.createElement("canvas");n.width=a;n.height=h;return n.getContext("2d")};function dataURItoBlob(a){var h=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var n=new ArrayBuffer(h.length),n=new DataView(n),r=0;r<h.length;r++){var u=h.charCodeAt(r);n.setUint8(r,u)}return new Blob([n],{type:a})};function merge_image(a,h,n,r,u){var f={data:{},set:function(a){this.data[a]||(this.data[a]=[]);this.data[a].push(Date.now())},get:function(){return this.data}};f.set("\u5168\u90e8");try{var w=[];h=JSON.parse(JSON.stringify(h));isNaN(h[0].zIndex)||h.sort(function(a,d){console.log(a,d);return a.zIndex-d.zIndex});var v=function(a,d,b){if(1==a.type){f.set("\u5716\u5c64"+d+"\u6587\u5b57\u5408\u6210");var c=merge_text(a,d,w);f.set("\u5716\u5c64"+d+"\u6587\u5b57\u5408\u6210");d=a.bgPadding?a.bgPadding:0;
if(a.useBg){a.x-=d;a.y-=d;var k=a.w+2*d,t=a.h+2*d,e=init_canvas(k,t);if(a.bgBorderRadius){var g=2*a.bgBorderRadius;e.lineJoin="round";e.lineWidth=g;e.strokeStyle=a.bgColor;e.strokeRect(g/2,g/2,k-g,t-g)}else g=0;e.fillStyle=a.bgColor;e.fillRect(g/2,g/2,k-g,t-g);e.drawImage(c,d,d,a.w,a.h);a.w=k;a.h=t;c=e.canvas}b&&b(c)}else if(2==a.type)c=new Image,f.set("\u5716\u5c64"+d+"\u5716\u7247\u8b80\u53d6"),c.onload=function(a,d){f.set("\u5716\u5c64"+d+"\u5716\u7247\u8b80\u53d6");b&&b(a)}.bind(this,c,d),c.src=
a.image_src;else throw"\u6709\u5716\u7247\u6f0f\u6389\u6c92\u5408\u6210";},m={finish_count:0},p;for(p in h){var q=h[p];v(q,p,function(l,d,b){l.image_object=b;d.finish_count++;if(h.length<=d.finish_count){l=init_canvas(a.w,a.h);a.format&&(a.format=a.format.toLowerCase(),d=(d=-1!=a.format.indexOf("jpeg"))||-1!=a.format.indexOf("jpg"))&&(l.fillStyle="#ffffff",l.fillRect(0,0,a.w,a.h));for(var c in h)if(d=h[c],d.image_object){b=d;if(b.rotate){var k=Math.sqrt(b.w*b.w+b.h*b.h),t=(k-b.w)/2,e=(k-b.h)/2,g=
init_canvas(k,k);g.translate(k/2,k/2);g.rotate(b.rotate*Math.PI/180);g.translate(-k/2,-k/2);g.drawImage(b.image_object,t,e);b.image_object=g.canvas;b.x-=t;b.y-=e;b.w=k;b.h=k}l.drawImage(d.image_object,d.x,d.y,d.w,d.h)}n&&n(l.canvas.toDataURL(a.format,a.compress));f.set("\u5168\u90e8");l=f.get();for(c in l)l[c]=(l[c][1]-l[c][0])/1E3;r&&r(l,w)}}.bind(this,q,m))}}catch(l){u&&u(l)}return this};function merge_text(a,h,n){function r(a,b,c,k){c||(c=[]);k||(k=Date.now());var d;if(-1==a.text_content.indexOf(" ")){var e=Math.floor(a.w/a.text_size*2);d=1;var g=e}else"string"==typeof a.text_content&&(a.text_content=a.text_content.split(" ")),d=2;for(var f=[];;){var e=1==d?a.text_content.substr(0,g):a.text_content.join(" "),h=b.measureText(e).width;if(1==d)if(h>a.w)g--;else{a.text_content=a.text_content.substr(e.length,a.text_content.length-e.length);break}else if(h>a.w)f.unshift(a.text_content.pop());
else{a.text_content=f;break}}-1!=e.indexOf("\n")&&(g=e.split("\n"),e=g.shift()+"\n",1==d?a.text_content=g.join("\n")+a.text_content:a.text_content.unshift(g.join("\n")));""!==e.trim()&&c.push(e.trim());if(1==d){if(""==a.text_content)return c}else a.text_content=a.text_content.join(" ");return 2E3<Date.now()-k?(console.log("\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7"),c):r(a,b,c,k)}function u(a,b,c){var d=c.measureText(a).width,f=1.2*b.text_size;b.useFontBg&&b.FontBgSize&&(f+=b.FontBgSize);c=
init_canvas(d,f);c.fillStyle=b.text_color;c.font=b.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";c.textBaseline="middle";var e=b.text_size/2;b.useFontBg&&b.FontBgSize&&(e+=b.FontBgSize/2,c.lineWidth=b.FontBgSize,c.strokeStyle=b.FontBgColor,c.strokeText(a,0,e));c.fillText(a,0,e);b.useLine&&(a=1==b.useLine?.9:.5,c.strokeStyle=b.text_color,c.lineWidth=Math.floor(b.text_size/10),e=f*a-c.lineWidth/2,c.moveTo(0,e),c.lineTo(d,e),c.stroke());return c.canvas}a.text_size>a.h&&(a.text_size=a.h);(function(a){var b=
a.text_content.length*a.text_size*a.text_size,c=Math.sqrt(b/(a.w/a.h)),b=b/c;c>b&&(b=c);a.text_size=Math.floor(a.w/b*a.text_size)})(a);var f=init_canvas(a.w,a.h);f.fillStyle=a.text_color;f.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";f.textBaseline="middle";a.useFontBg&&a.FontBgSize&&(f.lineWidth=a.FontBgSize,f.strokeStyle=a.FontBgColor,f.strokeText(m,p,q));2==a.text_type&&(a.text_content=a.text_content.split("").join("\n"));for(var w=0;;){w++;q=a.text_content;p=!1;if(1==a.text_type)var v=
[q],m=f.measureText(q).width,p=p||m>a.w;else v=r(a,f);m=v.length*(a.useFontBg&&a.FontBgSize?1.2*a.text_size+a.FontBgSize:1.2*a.text_size);if(p=p||m>a.h)f.font=--a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4",a.text_content=q;else break}var q=0;1==a.text_vAlign?q=(a.h-m)/2:2==a.text_vAlign&&(q=a.h-m);for(var l in v){var m=v[l],m=u(m,a,f),p=0;1==a.text_hAlign?p=(a.w-m.width)/2:2==a.text_hAlign&&(p=a.w-m.width);f.drawImage(m,p,q);q+=m.height}n.push("\u5716\u5c64"+h+"\u6587\u5b57\u5408\u6210\u5224\u65b7"+
w+"\u6b21");return f.canvas};
