function init_canvas(a,b){var c=document.createElement("canvas");c.width=a;c.height=b;return c.getContext("2d")};function dataURItoBlob(a){var b=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var c=new ArrayBuffer(b.length),c=new DataView(c),d=0;d<b.length;d++){var e=b.charCodeAt(d);c.setUint8(d,e)}return new Blob([c],{type:a})};function merge_image(a,b,c){b=JSON.parse(JSON.stringify(b));isNaN(b[0].zIndex)||b.sort(function(a,b){return a.zIndex-b.zIndex});this.error=function(a){};var d=function(a,b){if(1==a.type){var c=merge_text(a),f=a.bgPadding?a.bgPadding:0;if(a.useBg){a.x-=f;a.y-=f;var e=a.w+2*f,d=a.h+2*f,g=init_canvas(e,d);if(a.bgBorderRadius){var k=2*a.bgBorderRadius;g.lineJoin="round";g.lineWidth=k;g.strokeStyle=a.bgColor;g.strokeRect(k/2,k/2,e-k,d-k)}else k=0;g.fillStyle=a.bgColor;g.fillRect(k/2,k/2,e-k,d-k);g.drawImage(c,
f,f,a.w,a.h);a.w=e;a.h=d;c=g.canvas}b&&b(c)}else 2==a.type?(c=new Image,c.onload=function(a){b&&b(a)}.bind(this,c),c.src=a.image_src):(console.log("\u6709\u5716\u7247\u6f0f\u6389\u6c92\u5408\u6210"),b&&b(null))},e={finish_count:0},f;for(f in b){var h=b[f];d(h,function(f,e,d){f.image_object=d;e.finish_count++;if(b.length<=e.finish_count){f=init_canvas(a.w,a.h);a.format&&(a.format=a.format.toLowerCase(),e=(e=-1!=a.format.indexOf("jpeg"))||-1!=a.format.indexOf("jpg"))&&(f.fillStyle="#ffffff",f.fillRect(0,
0,a.w,a.h));for(var g in b)if(e=b[g],e.image_object){d=e;if(d.rotate){var h=Math.sqrt(d.w*d.w+d.h*d.h),l=(h-d.w)/2,m=(h-d.h)/2,k=init_canvas(h,h);k.translate(h/2,h/2);k.rotate(d.rotate*Math.PI/180);k.translate(-h/2,-h/2);k.drawImage(d.image_object,l,m);d.image_object=k.canvas;d.x-=l;d.y-=m;d.w=h;d.h=h}f.drawImage(e.image_object,e.x,e.y,e.w,e.h)}c&&c(f.canvas.toDataURL(a.format,a.compress))}}.bind(this,h,e))}};function area_scale_w_h(a){var b=a.text_content.length*a.text_size*a.text_size,c=Math.sqrt(b/(a.w/a.h)),b=b/c;c>b&&(b=c);a.text_size=Math.floor(a.w/b*a.text_size)}
function get_ok_width_string(a,b,c,d){c||(c=[]);d||(d=Date.now());var e;if(-1==a.text_content.indexOf(" ")){var f=Math.floor(a.w/a.text_size*2);e=1;var h=f}else"string"==typeof a.text_content&&(a.text_content=a.text_content.split(" ")),e=2;for(var g=[];;){var f=1==e?a.text_content.substr(0,h):a.text_content.join(" "),l=Math.floor(b.measureText(f).width);if(1==e)if(l>a.w)h--;else{a.text_content=a.text_content.substr(f.length,a.text_content.length-f.length);break}else if(l>a.w)g.unshift(a.text_content.pop());
else{a.text_content=g;break}}-1!=f.indexOf("\n")&&(h=f.split("\n"),f=h.shift()+"\n",1==e?a.text_content=h.join("\n")+a.text_content:a.text_content.unshift(h.join("\n")));""!==f.trim()&&c.push(f.trim());if(1==e){if(""==a.text_content)return c}else a.text_content=a.text_content.join(" ");return 2E3<Date.now()-d?(console.log("\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7"),c):get_ok_width_string(a,b,c,d)}
function make_text(a,b,c){var d=c.measureText(a).width;b.useFontBg&&(d+=b.FontBgSize);var e=1.2*b.text_size;b.useFontBg&&b.FontBgSize&&(e+=b.FontBgSize);c=init_canvas(d,e);c.fillStyle=b.text_color;c.font=b.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";c.textBaseline="middle";var f=b.text_size/2;b.useFontBg&&b.FontBgSize&&(f+=b.FontBgSize/2,c.lineWidth=b.FontBgSize,c.strokeStyle=b.FontBgColor,c.strokeText(a,0,f));c.fillText(a,0,f);b.useLine&&(f=1==b.useLine?.9:.5,c.strokeStyle=b.text_color,c.lineWidth=
Math.floor(b.text_size/10),b=d,f=e*f-c.lineWidth/2,c.moveTo(0,f),c.lineTo(b,f),c.stroke());return c.canvas}
function merge_text(a){a.text_size>a.h&&(a.text_size=a.h);area_scale_w_h(a);var b=init_canvas(a.w,a.h);b.fillStyle=a.text_color;b.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";b.textBaseline="middle";a.useFontBg&&a.FontBgSize&&(b.lineWidth=a.FontBgSize,b.strokeStyle=a.FontBgColor,b.strokeText(e,g,f));2==a.text_type&&(a.text_content=a.text_content.split("").join("\n"));for(f=0;;){f++;g=a.text_content;e=!1;if(1==a.text_type)var c=[g],d=b.measureText(g).width,e=e||d>a.w;else c=get_ok_width_string(a,
b);d=c.length*(a.useFontBg&&a.FontBgSize?1.2*a.text_size+a.FontBgSize:1.2*a.text_size);if(e=e||d>a.h)b.font=--a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4",a.text_content=g;else break}console.log("\u6587\u5b57\u5408\u6210\u5224\u65b7"+f+"\u6b21");var f=0;1==a.text_vAlign?f=(a.h-d)/2:2==a.text_vAlign&&(f=a.h-d);for(var h in c){var e=c[h],e=make_text(e,a,b),g=0;1==a.text_hAlign?g=(a.w-e.width)/2:2==a.text_hAlign&&(g=a.w-e.width);b.drawImage(e,g,f);f+=e.height}return b.canvas}
window.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.set_font_size=function(a,b){this.font=a+"px "+b});
