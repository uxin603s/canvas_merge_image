function init_canvas(a,l){var m=document.createElement("canvas");m.width=a;m.height=l;return m.getContext("2d")};function dataURItoBlob(a){var l=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var m=new ArrayBuffer(l.length),m=new DataView(m),q=0;q<l.length;q++){var t=l.charCodeAt(q);m.setUint8(q,t)}return new Blob([m],{type:a})};function merge_image(a,l,m,q,t){var g={data:{},set:function(a){this.data[a]||(this.data[a]=[]);this.data[a].push(Date.now())},get:function(){return this.data}};g.set("\u5168\u90e8");try{var u=[];l=JSON.parse(JSON.stringify(l));isNaN(l[0].zIndex)||l.sort(function(a,d){return a.zIndex-d.zIndex});var v=function(a,d,b){if(1==a.type){g.set("\u5716\u5c64"+d+"\u6587\u5b57\u5408\u6210");var c=merge_text(a,d,u);g.set("\u5716\u5c64"+d+"\u6587\u5b57\u5408\u6210");d=a.bgPadding?a.bgPadding:0;if(a.useBg){a.x-=
d;a.y-=d;var k=a.w+2*d,r=a.h+2*d,f=init_canvas(k,r);if(a.bgBorderRadius){var h=2*a.bgBorderRadius;f.lineJoin="round";f.lineWidth=h;f.strokeStyle=a.bgColor;f.strokeRect(h/2,h/2,k-h,r-h)}else h=0;f.fillStyle=a.bgColor;f.fillRect(h/2,h/2,k-h,r-h);f.drawImage(c,d,d,a.w,a.h);a.w=k;a.h=r;c=f.canvas}b&&b(c)}else if(2==a.type)c=new Image,g.set("\u5716\u5c64"+d+"\u5716\u7247\u8b80\u53d6"),c.onload=function(a,d){g.set("\u5716\u5c64"+d+"\u5716\u7247\u8b80\u53d6");b&&b(a)}.bind(this,c,d),c.src=a.image_src;else throw"\u6709\u5716\u7247\u6f0f\u6389\u6c92\u5408\u6210";
},e={finish_count:0},n;for(n in l){var p=l[n];v(p,n,function(e,d,b){e.image_object=b;d.finish_count++;if(l.length<=d.finish_count){e=init_canvas(a.w,a.h);a.format&&(a.format=a.format.toLowerCase(),d=(d=-1!=a.format.indexOf("jpeg"))||-1!=a.format.indexOf("jpg"))&&(e.fillStyle="#ffffff",e.fillRect(0,0,a.w,a.h));for(var c in l)if(d=l[c],d.image_object){b=d;if(b.rotate){var k=Math.sqrt(b.w*b.w+b.h*b.h),r=(k-b.w)/2,f=(k-b.h)/2,h=init_canvas(k,k);h.translate(k/2,k/2);h.rotate(b.rotate*Math.PI/180);h.translate(-k/
2,-k/2);h.drawImage(b.image_object,r,f);b.image_object=h.canvas;b.x-=r;b.y-=f;b.w=k;b.h=k}e.drawImage(d.image_object,d.x,d.y,d.w,d.h)}m&&m(e.canvas.toDataURL(a.format,a.compress));g.set("\u5168\u90e8");e=g.get();for(c in e)u.push(c+">>"+(e[c][1]-e[c][0])/1E3+"\u79d2");q&&q(u)}}.bind(this,p,e))}}catch(w){t&&t(w)}return this};function merge_text(a,l,m){function q(a,b,c,e){c||(c=[]);e||(e=Date.now());var d;if(-1==a.text_content.indexOf(" ")){var f=Math.floor(a.w/a.text_size*2);d=1;var h=f}else"string"==typeof a.text_content&&(a.text_content=a.text_content.split(" ")),d=2;for(var g=[];;){var f=1==d?a.text_content.substr(0,h):a.text_content.join(" "),k=b.measureText(f).width;if(1==d)if(k>a.w)h--;else{a.text_content=a.text_content.substr(f.length,a.text_content.length-f.length);break}else if(k>a.w)g.unshift(a.text_content.pop());
else{a.text_content=g;break}}-1!=f.indexOf("\n")&&(h=f.split("\n"),f=h.shift()+"\n",1==d?a.text_content=h.join("\n")+a.text_content:a.text_content.unshift(h.join("\n")));""!==f.trim()&&c.push(f.trim());if(1==d){if(""==a.text_content)return c}else a.text_content=a.text_content.join(" ");return 2E3<Date.now()-e?(console.log("\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7"),c):q(a,b,c,e)}function t(a,b,c){var d=c.measureText(a).width,e=1.2*b.text_size;b.useFontBg&&b.FontBgSize&&(e+=b.FontBgSize);c=
init_canvas(d,e);c.fillStyle=b.text_color;c.font=b.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";c.textBaseline="middle";var f=b.text_size/2;b.useFontBg&&b.FontBgSize&&(f+=b.FontBgSize/2,c.lineWidth=b.FontBgSize,c.strokeStyle=b.FontBgColor,c.strokeText(a,0,f));c.fillText(a,0,f);b.useLine&&(a=1==b.useLine?.9:.5,c.strokeStyle=b.text_color,c.lineWidth=Math.floor(b.text_size/10),f=e*a-c.lineWidth/2,c.moveTo(0,f),c.lineTo(d,f),c.stroke());return c.canvas}a.text_size>a.h&&(a.text_size=a.h);(function(a){var b=
a.text_content.length*a.text_size*a.text_size,c=Math.sqrt(b/(a.w/a.h)),b=b/c;c>b&&(b=c);a.text_size=Math.floor(a.w/b*a.text_size)})(a);var g=init_canvas(a.w,a.h);g.fillStyle=a.text_color;g.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";g.textBaseline="middle";a.useFontBg&&a.FontBgSize&&(g.lineWidth=a.FontBgSize,g.strokeStyle=a.FontBgColor,g.strokeText(e,n,p));2==a.text_type&&(a.text_content=a.text_content.split("").join("\n"));for(var u=0;;){u++;p=a.text_content;n=!1;if(1==a.text_type)var v=
[p],e=g.measureText(p).width,n=n||e>a.w;else v=q(a,g);e=v.length*(a.useFontBg&&a.FontBgSize?1.2*a.text_size+a.FontBgSize:1.2*a.text_size);if(n=n||e>a.h)g.font=--a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4",a.text_content=p;else break}var p=0;1==a.text_vAlign?p=(a.h-e)/2:2==a.text_vAlign&&(p=a.h-e);for(var w in v){var e=v[w],e=t(e,a,g),n=0;1==a.text_hAlign?n=(a.w-e.width)/2:2==a.text_hAlign&&(n=a.w-e.width);g.drawImage(e,n,p);p+=e.height}m.push("\u5716\u5c64"+l+"\u6587\u5b57\u5408\u6210\u5224\u65b7"+
u+"\u6b21");return g.canvas};
