function init_canvas(a,q){var w=document.createElement("canvas");w.width=a;w.height=q;return w.getContext("2d")};function dataURItoBlob(a){var q=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var w=new ArrayBuffer(q.length),w=new DataView(w),t=0;t<q.length;t++){var g=q.charCodeAt(t);w.setUint8(t,g)}return new Blob([w],{type:a})};function merge_image(a,q,w,t,g){var f={data:{},set:function(a){this.data[a]||(this.data[a]=[]);this.data[a].push(Date.now())},get:function(){return this.data}};f.set("\u5168\u90e8");try{var l=[];q=JSON.parse(JSON.stringify(q));isNaN(q[0].zIndex)||q.sort(function(a,c){return a.zIndex-c.zIndex});var u=function(a,c,e){if(1==a.type){f.set("\u5716\u5c64"+c+"\u6587\u5b57\u5408\u6210");var d=merge_text(a,c,l);f.set("\u5716\u5c64"+c+"\u6587\u5b57\u5408\u6210");c=a.bgPadding?a.bgPadding:0;if(a.useBg){a.x-=
c;a.y-=c;var k=a.w+2*c,b=a.h+2*c,h=init_canvas(k,b);if(a.bgBorderRadius){var n=2*a.bgBorderRadius;h.lineJoin="round";h.lineWidth=n;h.strokeStyle=a.bgColor;h.strokeRect(n/2,n/2,k-n,b-n)}else n=0;h.fillStyle=a.bgColor;h.fillRect(n/2,n/2,k-n,b-n);h.drawImage(d,c,c,a.w,a.h);a.w=k;a.h=b;d=h.canvas}e&&e(d)}else if(2==a.type)d=new Image,f.set("\u5716\u5c64"+c+"\u5716\u7247\u8b80\u53d6"),d.onload=function(a,d){f.set("\u5716\u5c64"+d+"\u5716\u7247\u8b80\u53d6");e&&e(a)}.bind(this,d,c),d.src=a.image_src;else throw"\u6709\u5716\u7247\u6f0f\u6389\u6c92\u5408\u6210";
},r={finish_count:0},p;for(p in q){var v=q[p];u(v,p,function(b,c,e){b.image_object=e;c.finish_count++;if(q.length<=c.finish_count){b=init_canvas(a.w,a.h);a.format&&(a.format=a.format.toLowerCase(),c=(c=-1!=a.format.indexOf("jpeg"))||-1!=a.format.indexOf("jpg"))&&(b.fillStyle="#ffffff",b.fillRect(0,0,a.w,a.h));for(var d in q)if(c=q[d],c.image_object){e=c;if(e.rotate){var k=Math.sqrt(e.w*e.w+e.h*e.h),x=(k-e.w)/2,h=(k-e.h)/2,n=init_canvas(k,k);n.translate(k/2,k/2);n.rotate(e.rotate*Math.PI/180);n.translate(-k/
2,-k/2);n.drawImage(e.image_object,x,h);e.image_object=n.canvas;e.x-=x;e.y-=h;e.w=k;e.h=k}b.drawImage(c.image_object,c.x,c.y,c.w,c.h)}w&&w(b.canvas.toDataURL(a.format,a.compress));f.set("\u5168\u90e8");b=f.get();for(d in b)b[d]=(b[d][1]-b[d][0])/1E3;t&&t(b,l)}}.bind(this,v,r))}}catch(b){g&&g(b)}return this};function merge_text(a){function q(a){for(var b in a)"object"==typeof a[b]?a[b]=q(a[b]):isNaN(a[b])||""==a[b]||(a[b]*=1);return a}function w(a,b,c,h,e){h.index=0;var k=[];if(-1!=a.text_content.indexOf("\n")){var n=a.text_content.split("\n"),d;for(d in n){var m=n[d],f=b.measureText(m).width;k.push({text:m,w:f})}return k}e||(e=0);var g=a.text_content,l=0;if(-1==h.source.indexOf(" ")){if(!c)if(c=0,h.list.length)for(d in h.list)m=h.list[d].text,m=b.measureText(m).width,m>c&&(c=m);else c=a.w;var p=Math.floor(c/
a.text_size*1.5),l=1,q=p}else{var l=2,v=b.measureText(" ").width,r=[],g=h.source.replace(/###user_name###/g,"").split(" ");c||(c=0);for(d in g)m=g[d].replace(/###space###/g," "),m=b.measureText(m).width,r.push(m),m>c&&(c=m)}for(var u=0;;){if(1==l)for(d in m=g.substr(0,q),h.index+=m.length,h.list){var n=h.list[d].start,t=h.list[d].end;if(n<=h.index&&h.index<t){h.index-=m.length;var x=n-h.index;0==x&&(x=t-n);m=g.substr(0,x);h.index+=m.length}}else{t=r.length;do if(n=r.slice(0,t),f=n.reduce(function(a,
b){var c=0;0!=a&&(c+=v);return c+(a+b)},0),f>c)t--;else break;while(1);m=g.splice(0,t).join(" ").replace(/###space###/g," ");f=b.measureText(m).width;r.splice(0,t)}if(1==l)if(f=b.measureText(m).width,f>c)h.index-=m.length,q--;else{if(u=0,n=m.length,x=g.length-m.length,g=g.substr(n,x),m&&k.push({text:m,w:f}),q=p,!g.length){if(!h.list.length&&(x=k.length,1!=x&&k[x-2].w/2>k[x-1].w)){k=[];c*=1.1;p=Math.floor(c/a.text_size*1.5);g=a.text_content;continue}break}}else if(m&&k.push({text:m,w:f}),!g.length)break;
if(1E3<++u)throw console.log(h.source,k,u),"\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7";}g=1.2*a.text_size;a.useFontBg&&a.FontBgSize&&(g+=a.FontBgSize);l=f=0;for(d in k)l?k[d].w<l&&(l=k[d].w):l=k[d].w,k[d].w>f&&(f=k[d].w);d=g*k.length;f=f*a.h/a.w;if(1!=k.length&&f<d){c*=1.1;if(100<e)throw console.log("error",h.source,c,a.text_size,f,d),"\u5361\u8ff4\u5708";return w(a,b,c,h,++e)}return k}function t(a,b,c,e){var d=init_canvas(c,e);d.fillStyle=b.text_color;d.font=b.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";
d.textBaseline="middle";b.useFontBg&&b.FontBgSize&&(d.lineWidth=b.FontBgSize,d.strokeStyle=b.FontBgColor);var f=0,g=b.text_size/2;b.useFontBg&&b.FontBgSize&&(f+=b.FontBgSize);b.useFontBg&&b.FontBgSize&&d.strokeText(a,f,g);d.fillText(a,f,g);b.useLine&&(a=1==b.useLine?.9:.5,d.strokeStyle=b.text_color,d.lineWidth=Math.floor(b.text_size/10),g=e*a-d.lineWidth/2,d.moveTo(0,g),d.lineTo(c,g),d.stroke());return d.canvas}a=JSON.parse(JSON.stringify(a));a=q(a);a.text_content=a.text_content.toString().trim();
a.text_size>a.h&&(a.text_size=a.h);var g=a.text_content.match(/###user_name###([\w\W]+?)###user_name###/g),f={source:a.text_content,list:[],index:0};if(g){for(var l in g){var u=a.text_content.indexOf(g[l]),r=g[l].length,p=a.text_content.split(""),v=p.slice(u,u+r).join(""),b=v.replace(/###user_name###/g,"").replace(/###space###/g," ");p.splice(u,r,b);a.text_content=p.join("");f.list.push({text:b,source:v,start:u,count:b.length,end:u+b.length})}f.list.reverse()}(function(a){var b=a.text_content.length,
c=a.text_size;a.useFontBg&&a.FontBgSize&&(c+=2*a.FontBgSize);a.text_size=Math.floor(a.text_size*Math.sqrt(a.w*a.h/(b*c*c*1.44)))})(a);g=init_canvas(a.w,a.h);g.fillStyle=a.text_color;g.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";g.textBaseline="middle";a.useFontBg&&a.FontBgSize&&(g.lineWidth=a.FontBgSize,g.strokeStyle=a.FontBgColor);20>a.text_size&&(a.text_size=20,g.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4");0!=a.text_type||a.text_content.match(/[^a-zA-Z0-9\.]+/)||(a.text_type=
1);if(0==a.text_type)var c=w(a,g,void 0,f);else if(1==a.text_type)a.text_content=a.text_content.replace(/###user_name###/g,"").replace(/###space###/g," "),b=a.text_content,f=Math.ceil(g.measureText(b).width),c=[{text:b,w:f}];else if(2==a.text_type){a.text_content=a.text_content.replace(/###user_name###/g,"").replace(/###space###/g," ");p=a.text_content.split("");c=[];for(l in p)b=p[l],f=Math.ceil(g.measureText(b).width),c.push({text:b,w:f});console.log(c)}var e=1.2*a.text_size,b=0;for(l in c)c[l].w>
b&&(b=c[l].w);b=Math.ceil(b);e=Math.ceil(e);a.useFontBg&&a.FontBgSize&&(b+=2*a.FontBgSize,e+=a.FontBgSize);p=b;f=e*c.length;u=[];for(l in c)v=c[l],b=v.text,r=v.w,a.useFontBg&&a.FontBgSize&&(r+=2*a.FontBgSize),r=Math.ceil(r),b=t(b,a,r,e),u.push(b);c=init_canvas(p,f);e=b=0;for(l in u)v=u[l],r=v.width,v=v.height,0==a.text_hAlign?b=0:1==a.text_hAlign?b=(p-r)/2:2==a.text_hAlign&&(b=p-r),c.drawImage(u[l],b,e,r,v),e+=v;l=a.w/p;p*=l;f*=l;f>a.h&&(l=a.h/f,p*=l,f*=l);e=b=0;0==a.text_hAlign?b=0:1==a.text_hAlign?
b=(a.w-p)/2:2==a.text_hAlign&&(b=a.w-p);0==a.text_vAlign?e=0:1==a.text_vAlign?e=(a.h-f)/2:2==a.text_vAlign&&(e=a.h-f);g.drawImage(c.canvas,b,e,p,f);return g.canvas};
