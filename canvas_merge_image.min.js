function init_canvas(a,r){var t=document.createElement("canvas");t.width=a;t.height=r;return t.getContext("2d")};function dataURItoBlob(a){var r=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var t=new ArrayBuffer(r.length),t=new DataView(t),d=0;d<r.length;d++){var g=r.charCodeAt(d);t.setUint8(d,g)}return new Blob([t],{type:a})};function merge_image(a,r,t,d,g){var e={data:{},set:function(a){this.data[a]||(this.data[a]=[]);this.data[a].push(Date.now())},get:function(){return this.data}};e.set("\u5168\u90e8");try{var w=[];r=JSON.parse(JSON.stringify(r));isNaN(r[0].zIndex)||r.sort(function(a,c){return a.zIndex-c.zIndex});var v=function(a,c,b){if(1==a.type){e.set("\u5716\u5c64"+c+"\u6587\u5b57\u5408\u6210");var l=merge_text(a,c,w);e.set("\u5716\u5c64"+c+"\u6587\u5b57\u5408\u6210");c=a.bgPadding?a.bgPadding:0;if(a.useBg){a.x-=
c;a.y-=c;var f=a.w+2*c,x=a.h+2*c,h=init_canvas(f,x);if(a.bgBorderRadius){var q=2*a.bgBorderRadius;h.lineJoin="round";h.lineWidth=q;h.strokeStyle=a.bgColor;h.strokeRect(q/2,q/2,f-q,x-q)}else q=0;h.fillStyle=a.bgColor;h.fillRect(q/2,q/2,f-q,x-q);h.drawImage(l,c,c,a.w,a.h);a.w=f;a.h=x;l=h.canvas}b&&b(l)}else if(2==a.type)l=new Image,e.set("\u5716\u5c64"+c+"\u5716\u7247\u8b80\u53d6"),l.onload=function(a,f){e.set("\u5716\u5c64"+f+"\u5716\u7247\u8b80\u53d6");b&&b(a)}.bind(this,l,c),l.src=a.image_src;else throw"\u6709\u5716\u7247\u6f0f\u6389\u6c92\u5408\u6210";
},n={finish_count:0},m;for(m in r){var b=r[m];v(b,m,function(b,c,p){b.image_object=p;c.finish_count++;if(r.length<=c.finish_count){b=init_canvas(a.w,a.h);a.format&&(a.format=a.format.toLowerCase(),c=(c=-1!=a.format.indexOf("jpeg"))||-1!=a.format.indexOf("jpg"))&&(b.fillStyle="#ffffff",b.fillRect(0,0,a.w,a.h));for(var l in r)if(c=r[l],c.image_object){p=c;if(p.rotate){var f=Math.sqrt(p.w*p.w+p.h*p.h),x=(f-p.w)/2,h=(f-p.h)/2,q=init_canvas(f,f);q.translate(f/2,f/2);q.rotate(p.rotate*Math.PI/180);q.translate(-f/
2,-f/2);q.drawImage(p.image_object,x,h);p.image_object=q.canvas;p.x-=x;p.y-=h;p.w=f;p.h=f}b.drawImage(c.image_object,c.x,c.y,c.w,c.h)}t&&t(b.canvas.toDataURL(a.format,a.compress));e.set("\u5168\u90e8");b=e.get();for(l in b)b[l]=(b[l][1]-b[l][0])/1E3;d&&d(b,w)}}.bind(this,b,n))}}catch(u){g&&g(u)}return this};function merge_text(a){function r(a,b,c,h,q){h.index=0;var f=[];if(-1!=a.text_content.indexOf("\n")){var l=a.text_content.split("\n"),e;for(e in l){var k=l[e],d=b.measureText(k).width;f.push({text:k,w:d})}return f}q||(q=0);var g=a.text_content,n=0;if(-1==h.source.indexOf(" ")){if(!c)if(c=0,h.list.length)for(e in h.list)k=h.list[e].text,k=b.measureText(k).width,k>c&&(c=k);else c=a.w;var m=Math.floor(c/a.text_size*1.5),n=1,u=m}else{g=h.source.replace(/###user_name###/g,"").split(" ");if(!c)for(e in c=
0,g)k=g[e].replace(/###space###/g," "),k=b.measureText(k).width,k>c&&(c=k);var n=2,x=b.measureText(" ").width,t=[];for(e in g)k=g[e].replace(/###space###/g," "),t.push(b.measureText(k).width)}Date.now();for(var w=0;;){if(1==n)for(e in k=g.substr(0,u),h.index+=k.length,h.list){var l=h.list[e].start,v=h.list[e].end;if(l<=h.index&&h.index<v){h.index-=k.length;var y=l-h.index;0==y&&(y=v-l);k=g.substr(0,y);h.index+=k.length}}else{v=t.length;do if(l=t.slice(0,v),d=l.reduce(function(a,b){var c=0;0!=a&&(c+=
x);return c+(a+b)},0),d>c)v--;else break;while(1);k=g.splice(0,v).join(" ").replace(/###space###/g," ");d=b.measureText(k).width;t.splice(0,v)}if(1==n)if(d=b.measureText(k).width,d>c)h.index-=k.length,u--;else{if(w=0,l=k.length,y=g.length-k.length,g=g.substr(l,y),k&&f.push({text:k,w:d}),u=m,!g.length){if(!h.list.length&&(y=f.length,1!=y&&f[y-2].w/2>f[y-1].w)){f=[];c*=1.1;m=Math.floor(c/a.text_size*1.5);g=a.text_content;continue}break}}else if(k&&f.push({text:k,w:d}),!g.length)break;if(1E3<++w)throw console.log(h.source,
f,w),"\u5361\u8ff4\u5708\uff0c\u5f37\u5236\u4e2d\u65b7";}g=1.2*a.text_size;a.useFontBg&&a.FontBgSize&&(g+=a.FontBgSize);m=d=0;for(e in f)m?f[e].w<m&&(m=f[e].w):m=f[e].w,f[e].w>d&&(d=f[e].w);e=g*f.length;d=p=d*a.h/a.w;if(1!=f.length&&d<e){c*=1.1;if(100<q)throw console.log("error",h.source,c,a.text_size,d,e),"\u5361\u8ff4\u5708";return r(a,b,c,h,++q)}return f}function t(a,b,c,e){var d=init_canvas(c,e);d.fillStyle=b.text_color;d.font=b.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";d.textBaseline="middle";
b.useFontBg&&b.FontBgSize&&(d.lineWidth=b.FontBgSize,d.strokeStyle=b.FontBgColor);var g=0,f=b.text_size/2;b.useFontBg&&b.FontBgSize&&(g+=b.FontBgSize);b.useFontBg&&b.FontBgSize&&d.strokeText(a,g,f);d.fillText(a,g,f);b.useLine&&(a=1==b.useLine?.9:.5,d.strokeStyle=b.text_color,d.lineWidth=Math.floor(b.text_size/10),f=e,b.useFontBg&&b.FontBgSize&&(f-=b.FontBgSize),f=f*a-d.lineWidth/2,d.moveTo(0,f),d.lineTo(c,f),d.stroke());return d.canvas}a=JSON.parse(JSON.stringify(a));a.text_content=a.text_content.toString().trim();
a.text_size>a.h&&(a.text_size=a.h);var d=a.text_content.match(/###user_name###([\w\W]+?)###user_name###/g),g={source:a.text_content,list:[],index:0};if(d){for(var e in d){var w=a.text_content.indexOf(d[e]),v=d[e].length,n=a.text_content.split(""),m=n.slice(w,w+v).join(""),b=m.replace(/###user_name###/g,"").replace(/###space###/g," ");n.splice(w,v,b);a.text_content=n.join("");g.list.push({text:b,source:m,start:w,count:b.length,end:w+b.length})}g.list.reverse()}(function(a){var b=a.text_content.length,
c=a.text_size;a.useFontBg&&a.FontBgSize&&(c+=2*a.FontBgSize);a.text_size=Math.floor(a.text_size*Math.sqrt(a.w*a.h/(b*c*c*1.44)))})(a);d=init_canvas(a.w,a.h);d.fillStyle=a.text_color;d.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4";d.textBaseline="middle";a.useFontBg&&a.FontBgSize&&(d.lineWidth=a.FontBgSize,d.strokeStyle=a.FontBgColor);20>a.text_size&&(a.text_size=20,d.font=a.text_size+"px \u5fae\u8edf\u6b63\u9ed1\u9ad4");0!=a.text_type||a.text_content.match(/[^a-zA-Z0-9\.]+/)||(a.text_type=
1);if(0==a.text_type)var u=r(a,d,void 0,g);else if(1==a.text_type)a.text_content=a.text_content.replace(/###user_name###/g," "),b=a.text_content,g=Math.ceil(d.measureText(b).width),u=[{text:b,w:g}];else if(2==a.text_type)for(e in a.text_content=a.text_content.replace(/###user_name###/g," "),n=a.text_content.split(""),u=[],n)b=n[e],g=Math.ceil(d.measureText(b).width),u.push({text:b,w:g});var c=1.2*a.text_size,b=0;for(e in u)u[e].w>b&&(b=u[e].w);b=Math.ceil(b);c=Math.ceil(c);a.useFontBg&&a.FontBgSize&&
(b+=a.FontBgSize,c+=a.FontBgSize);n=b;g=c*u.length;w=[];for(e in u)v=u[e],b=v.text,m=v.w,a.useFontBg&&a.FontBgSize&&(m+=2*a.FontBgSize),m=Math.ceil(m),b=t(b,a,m,c),w.push(b);u=init_canvas(n,g);c=b=0;for(e in w){var v=w[e],m=v.width,p=v.height;0==a.text_hAlign?b=0:1==a.text_hAlign?b=(n-m)/2:2==a.text_hAlign&&(b=n-m);u.drawImage(w[e],b,c,m,p);c+=p}e=a.w/n;n*=e;g*=e;g>a.h&&(e=a.h/g,n*=e,g*=e);c=b=0;0==a.text_hAlign?b=0:1==a.text_hAlign?b=(a.w-n)/2:2==a.text_hAlign&&(b=a.w-n);0==a.text_vAlign?c=0:1==
a.text_vAlign?c=(a.h-g)/2:2==a.text_vAlign&&(c=a.h-g);d.drawImage(u.canvas,b,c,n,g);return d.canvas};
